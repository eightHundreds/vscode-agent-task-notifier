name: Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Build, Release, and Publish
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.event.created == true && github.event.deleted == false }}
    env:
      VSCE_PAT: ${{ secrets.VSCE_PAT }}
      OVSX_PAT: ${{ secrets.OVSX_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Validate tag version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          TAG_VERSION="${TAG#v}"

          if [[ -z "${TAG}" ]]; then
            echo "::error::Empty tag name."
            exit 1
          fi

          if [[ "${TAG_VERSION}" != "${PKG_VERSION}" ]]; then
            echo "::error::Tag (${TAG}) must match package.json version (${PKG_VERSION}) with optional v prefix."
            exit 1
          fi

          VSIX_FILE="artifacts/vscode-agent-task-notifier-${PKG_VERSION}.vsix"
          echo "pkg_version=${PKG_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "vsix_file=${VSIX_FILE}" >> "${GITHUB_OUTPUT}"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build extension
        run: npm run build

      - name: Package VSIX
        run: |
          set -euo pipefail
          mkdir -p artifacts
          npx --yes @vscode/vsce package --no-yarn --out "${{ steps.vars.outputs.vsix_file }}"
          sha256sum "${{ steps.vars.outputs.vsix_file }}" > artifacts/SHA256SUMS.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.vars.outputs.vsix_file }}
            artifacts/SHA256SUMS.txt

      - name: Publish to VS Code Marketplace
        if: ${{ env.VSCE_PAT != '' }}
        run: |
          npx --yes @vscode/vsce publish --packagePath "${{ steps.vars.outputs.vsix_file }}" --pat "${VSCE_PAT}" --skip-duplicate

      - name: Publish to Open VSX
        if: ${{ env.OVSX_PAT != '' }}
        run: |
          npx --yes ovsx publish --packagePath "${{ steps.vars.outputs.vsix_file }}" -p "${OVSX_PAT}" --skip-duplicate
